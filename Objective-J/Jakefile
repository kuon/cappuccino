require('../jakelib/utils.js');

var FILE = require('fs');
var sharedSources = new jake.FileList();
sharedSources.include('Sources/*.js');
sharedSources = sharedSources.toArray();

var environments = FILE.readdirSync('Environments');

var environmentTargets = [];

var BUILD_DIR = '../Build/Objective-J';
directory(BUILD_DIR);

// Create one task per environment
environments.forEach(function(env) {
    var source = 'Environments/' + env + '/Objective-J.' + env + '.js',
        target = BUILD_DIR + '/Objective-J.' + env + '.js',
        envSources = new jake.FileList(),
        flags = ['-ISources',  '-IEnvironments/' + env];

    envSources.include('Environments/' + env + '/*');
    envSources = envSources.toArray();

    environmentTargets.push(target);

    desc('Preprocess ' + env + 'environment');
    file(target, [BUILD_DIR].concat(sharedSources).concat(envSources), function () {
        cpp(source, target, flags);
    }, {async: true});
});


task('default', environmentTargets, function() {
    console.log('# Objective-J built');
});
